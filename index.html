<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Knowledge Center - Home</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css"
    />
    <style>
      :root {
        --primary: #102c57;
        --secondary: #2d6a91;
        --accent: #4a9dff;
        --light: #f8f9fa;
        --dark: #212529;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .navbar {
        background: var(--primary);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .hero-section {
        background: linear-gradient(
            rgba(16, 44, 87, 0.9),
            rgba(16, 44, 87, 0.8)
          ),
          url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><rect fill="%23102c57" width="1200" height="800"/><path fill="%232d6a91" d="M0,0 L1200,800 L0,800 Z"/></svg>');
        background-size: cover;
        color: white;
        padding: 4rem 0;
        margin-bottom: 3rem;
        border-radius: 0 0 20px 20px;
      }

      .card-menu {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
        height: 100%;
      }

      .card-menu:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }

      .card-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: var(--primary);
      }

      .card-home {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      }

      .card-dashboard {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      }

      .card-guidance {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      }

      .btn-primary-custom {
        color: antiquewhite;
        background: var(--primary);
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 50px;
        transition: all 0.3s ease;
      }

      .btn-primary-custom:hover {
        background: var(--secondary);
        transform: scale(1.05);
      }

      .footer {
        background: var(--dark);
        color: white;
        padding: 2rem 0;
        margin-top: 4rem;
      }

      .feature-highlight {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        margin-top: 2rem;
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <i
            class="bi bi-journal-bookmark-fill me-2"
            style="font-size: 1.8rem"
          ></i>
          <span class="fw-bold">Knowledge Center</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto" id="navMenu">
            <!-- Menu akan diisi secara dinamis -->
          </ul>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="container text-center">
        <h1 class="display-4 fw-bold mb-3">Sales & Store Knowledge Center</h1>
        <p class="lead mb-4">
          Platform terpadu untuk meningkatkan pengetahuan sales person dan
          informasi store terkini
        </p>
        <a href="#menu-cards" class="btn btn-light btn-lg px-4">
          <i class="bi bi-arrow-down-circle me-2"></i>Explore Menu
        </a>
      </div>
    </section>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Memuat menu...</p>
    </div>

    <!-- Main Menu Cards -->
    <section id="menu-cards" class="container mb-5">
      <div class="row g-4" id="menuCardsContainer">
        <!-- Cards akan diisi secara dinamis oleh JavaScript -->
      </div>
    </section>

    <!-- Features Highlight -->
    <section class="container">
      <div class="feature-highlight">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h2 class="h3 mb-3">Tingkatkan Pengetahuan & Performa Tim Sales</h2>
            <p class="mb-4">
              Knowledge Center ini dirancang khusus untuk mendukung perkembangan
              pengetahuan sales person dan menyediakan informasi store yang
              terupdate. Dengan akses mudah ke materi pembelajaran dan dashboard
              performa, tim sales dapat terus berkembang dan mencapai target
              yang lebih baik.
            </p>
            <div class="d-flex gap-3 flex-wrap">
              <span class="badge bg-primary p-2"
                ><i class="bi bi-check-circle me-1"></i> Materi Terupdate</span
              >
              <span class="badge bg-primary p-2"
                ><i class="bi bi-check-circle me-1"></i> Akses Mudah</span
              >
              <span class="badge bg-primary p-2"
                ><i class="bi bi-check-circle me-1"></i> Interface
                Responsif</span
              >
              <span class="badge bg-primary p-2"
                ><i class="bi bi-check-circle me-1"></i> Data Real-time</span
              >
            </div>
          </div>
          <div class="col-md-4 text-center">
            <i
              class="bi bi-bar-chart-fill"
              style="font-size: 5rem; color: var(--primary)"
            ></i>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5 class="mb-3">Knowledge Center</h5>
            <p>
              Platform terpadu untuk pengembangan pengetahuan sales person dan
              informasi store.
            </p>
          </div>
          <div class="col-md-3">
            <h5 class="mb-3">Quick Links</h5>
            <ul class="list-unstyled" id="footerLinks">
              <!-- Links akan diisi secara dinamis -->
            </ul>
          </div>
          <div class="col-md-3">
            <h5 class="mb-3">Kontak</h5>
            <ul class="list-unstyled">
              <li>
                <i class="bi bi-envelope me-2"></i> info@knowledgecenter.com
              </li>
              <li><i class="bi bi-telephone me-2"></i> (021) 1234-5678</li>
            </ul>
          </div>
        </div>
        <hr class="my-4 bg-light" />
        <div class="text-center">
          <p class="mb-0">&copy; 2024 Knowledge Center. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // ⭐️ GANTI DENGAN URL GAS WEB APP ANDA
      const GAS_WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbykARSnuRADfneFHty8Dlzj1EXvOAOBbrYkW-JPXjdRRQXS_87Er_fQaB-rEccbuCEI/exec";

      // KONSTANTA CACHING
      const CACHE_KEY_MENU = "routingMenuData";
      const LAST_FETCH_TIME_KEY_MENU = "lastFetchTimeMenu";
      // Data dianggap kedaluwarsa setelah 1 jam (dalam milidetik)
      const CACHE_EXPIRY_MS = 60 * 60 * 1000; // 1 jam

      // Mapping icon untuk setiap menu
      const menuIcons = {
        Home: "bi-house-door-fill",
        Dashboard: "bi-speedometer2",
        "Guidance Material": "bi-journal-text",
      };

      // Mapping class warna untuk card
      const cardClasses = {
        Home: "card-home",
        Dashboard: "card-dashboard",
        "Guidance Material": "card-guidance",
      };

      // ----------------------------------------------------
      // FUNGSI UTAMA: LOGIC CACHING & BACKGROUND FETCH
      // ----------------------------------------------------

      /**
       * Mengambil data menu. Mengutamakan cache. Jika cache expired,
       * mengembalikan data cache lama, dan memicu fetch baru di background.
       * @returns {Promise<Array>} Array data menu.
       */
      async function fetchMenuData() {
        const cachedData = localStorage.getItem(CACHE_KEY_MENU);
        const lastFetch = localStorage.getItem(LAST_FETCH_TIME_KEY_MENU);
        const currentTime = new Date().getTime();
        let menuData = [];
        let isCacheValid = false;

        if (cachedData && lastFetch) {
          const timeElapsed = currentTime - parseInt(lastFetch);

          try {
            const parsedData = JSON.parse(cachedData);
            menuData = parsedData.data || [];

            if (menuData.length > 0) {
              isCacheValid = timeElapsed < CACHE_EXPIRY_MS;

              // ⭐️ SELALU KEMBALIKAN DATA CACHE LAMA TERLEBIH DAHULU
              if (isCacheValid || timeElapsed < CACHE_EXPIRY_MS * 2) {
                console.log(`Menu loaded from cache. Valid: ${isCacheValid}`);
                return menuData;
              }
            }
          } catch (e) {
            console.error("Error parsing cached menu data.");
          }
        }

        // ⭐️ Jika tidak ada cache atau cache expired, fetch data baru (baik foreground/background)
        return fetchNewMenuData(menuData);
      }

      /**
       * Melakukan fetch data baru dari GAS dan mengupdate cache.
       * @param {Array} fallbackData Data lama untuk ditampilkan jika fetch gagal.
       */
      async function fetchNewMenuData(fallbackData = []) {
        try {
          const response = await fetch(`${GAS_WEB_APP_URL}?action=get_menu`);
          const result = await response.json();

          if (!response.ok || !result.success) {
            throw new Error(
              result.message || "Gagal memuat data menu dari server"
            );
          }

          const menuData = result.data || [];

          // 3. Simpan Data Baru ke Local Storage
          if (menuData.length > 0) {
            localStorage.setItem(CACHE_KEY_MENU, JSON.stringify(result));
            localStorage.setItem(
              LAST_FETCH_TIME_KEY_MENU,
              new Date().getTime().toString()
            );
            console.log("Menu data fetched and cached successfully.");

            // ⭐️ Jika fetch berhasil, panggil render ulang untuk update tampilan
            renderNavigationMenu(menuData);
            renderMenuCards(menuData);
            renderFooterLinks(menuData);
          }

          return menuData;
        } catch (error) {
          console.error("Error fetching menu data (BG):", error);
          if (fallbackData.length === 0) {
            showError("Gagal memuat data menu: " + error.message);
          }
          return fallbackData; // Kembalikan data lama jika ada, atau kosong
        }
      }

      // ----------------------------------------------------
      // FUNGSI RENDER
      // ----------------------------------------------------

      // Fungsi untuk menampilkan menu di navigation
      function renderNavigationMenu(menuData) {
        const navMenu = document.getElementById("navMenu");
        navMenu.innerHTML = "";

        menuData.forEach((menu) => {
          const isActive = window.location.pathname.endsWith(menu.href);
          const listItem = document.createElement("li");
          listItem.className = "nav-item";

          listItem.innerHTML = `
                <a class="nav-link ${isActive ? "active" : ""}" href="${
            menu.href
          }">
                    ${menu.menu_name}
                </a>
            `;
          navMenu.appendChild(listItem);
        });
      }

      // Fungsi untuk menampilkan cards
      function renderMenuCards(menuData) {
        const container = document.getElementById("menuCardsContainer");
        container.innerHTML = ""; // Clear existing content

        menuData.forEach((menu) => {
          const icon = menuIcons[menu.menu_name] || "bi-box";
          const cardClass = cardClasses[menu.menu_name] || "card-home";

          const col = document.createElement("div");
          col.className = "col-md-4";

          col.innerHTML = `
                <div class="card card-menu ${cardClass}">
                    <div class="card-body text-center p-4">
                        <div class="card-icon">
                            <i class="bi ${icon}"></i>
                        </div>
                        <h3 class="card-title h4">${menu.menu_name}</h3>
                        <p class="card-text text-muted mb-4">
                            ${menu.captions}
                        </p>
                        <a href="${menu.href}" class="btn btn-primary-custom">
                            <i class="bi ${
                              icon.split("-")[0]
                            }-up me-1"></i> Buka ${menu.menu_name}
                        </a>
                    </div>
                </div>
            `;
          container.appendChild(col);
        });
      }

      // Fungsi untuk menampilkan footer links
      function renderFooterLinks(menuData) {
        const footerLinks = document.getElementById("footerLinks");
        footerLinks.innerHTML = "";

        menuData.forEach((menu) => {
          const listItem = document.createElement("li");
          listItem.innerHTML = `<a href="${menu.href}" class="text-light">${menu.menu_name}</a>`;
          footerLinks.appendChild(listItem);
        });
      }

      // Fungsi untuk menampilkan loading
      function showLoading(show) {
        const spinner = document.getElementById("loadingSpinner");
        spinner.style.display = show ? "block" : "none";
      }

      // Fungsi untuk menampilkan error
      function showError(message) {
        const container = document.getElementById("menuCardsContainer");
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger text-center">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            </div>
        `;
      }

      // ----------------------------------------------------
      // INITIATOR
      // ----------------------------------------------------

      async function initializeApp() {
        // Tampilkan loading spinner di awal
        showLoading(true);

        const menuDataPromise = fetchMenuData();
        const initialMenuData = await menuDataPromise;

        // 1. Render UI dengan data yang tersedia (baik cache lama atau fetch baru)
        if (initialMenuData.length > 0) {
          renderNavigationMenu(initialMenuData);
          renderMenuCards(initialMenuData);
          renderFooterLinks(initialMenuData);
        } else {
          showError("Data menu tidak ditemukan.");
        }

        // 2. Sembunyikan loading spinner setelah rendering pertama
        showLoading(false);

        // ⭐️ Jika data yang dikembalikan adalah data cache lama/expired,
        // fetchNewMenuData (di dalam fetchMenuData) akan otomatis me-render ulang
        // secara asinkron. Tidak perlu logic tambahan di sini.
      }

      // Jalankan ketika DOM siap
      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
