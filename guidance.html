<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Guidance Menu</title>
    <script src="asset/js/config.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="asset/css/style.css" />
    <style>
      :root {
        --accent: #102c57;
        --bg: #f7fafc;
      }
      body {
        background-color: var(--bg);
      }
      .container {
        max-width: 980px;
      }
      .card-custom {
        margin-top: 10px !important;
      }
      .header-bg {
        background-color: var(--accent);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
      }
      .guidance-img {
        width: 100%;
        /* height: 200px; */
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 15px;
      }

      /* STYLE BARU UNTUK GRID LAYOUT */
      .guidance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
      }
      .title-card {
        border: 1px solid #e0e0e0;
        border-radius: 0.75rem;
        overflow: hidden;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        cursor: pointer;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .title-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        border-color: var(--accent);
      }
      .title-card-header {
        background-color: var(--accent);
        color: white;
        padding: 1.25rem;
        font-weight: 600;
        text-align: center;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .title-card-body {
        padding: 1rem;
        background-color: #f8f9fa;
        border-top: 1px solid #e9ecef;
        text-align: center;
        font-size: 0.9rem;
        color: #6c757d;
      }

      /* Modal untuk menampilkan konten */
      .content-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        overflow-y: auto;
      }
      .modal-content {
        position: relative;
        background-color: white;
        margin: 2rem auto;
        border-radius: 0.75rem;
        max-width: 800px;
        width: 90%;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        background-color: var(--accent);
        color: white;
        padding: 1.5rem;
        border-radius: 0.75rem 0.75rem 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-title {
        margin: 0;
        font-size: 1.25rem;
      }
      .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
      }
      .close-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      .modal-body {
        padding: 1.5rem;
        max-height: 70vh;
        overflow-y: auto;
      }

      /* Style untuk sub-title list */
      .subtitle-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .subtitle-item {
        padding: 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        justify-content: between;
        align-items: center;
      }
      .subtitle-item:hover {
        background-color: #e9ecef;
        border-color: var(--accent);
        transform: translateX(5px);
      }
      .subtitle-text {
        flex-grow: 1;
        font-weight: 600;
        color: #102c57;
        margin: 0;
      }
      .subtitle-arrow {
        color: #6c757d;
        font-size: 1.2rem;
      }

      /* Style untuk konten detail */
      .content-detail {
        display: none;
      }
      .back-btn {
        background: none;
        border: none;
        color: #102c57;
        font-size: 1rem;
        cursor: pointer;
        padding: 0.5rem 0;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: color 0.2s;
      }
      .back-btn:hover {
        color: #0a1f3d;
      }
      .detail-title {
        font-weight: bold;
        margin-bottom: 1rem;
        color: #102c57;
        border-bottom: 2px solid var(--accent);
        padding-bottom: 0.5rem;
      }
      .guidance-text {
        text-align: justify;
        margin-bottom: 0.75rem;
        line-height: 1.5;
      }

      .no-data-message {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem;
        color: #6c757d;
        font-size: 1.1rem;
      }

      @media (max-width: 768px) {
        .guidance-grid {
          grid-template-columns: 1fr;
        }
        .modal-content {
          width: 95%;
          margin: 1rem auto;
        }
      }

      /* 7. PDF WRAPPER & IMAGE (Seamless Look) */
      .pdf-wrapper {
        position: relative;
        width: 100%;
        height: 80vh;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid #f0f0f0;
      }
      .pdf-frame {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
      }
      .pdf-action-bar {
        display: flex;
        justify-content: flex-end;
        padding: 12px 0;
        border-top: 1px solid #f0f0f0;
        margin-top: 10px;
      }

      .modal-backdrop.show {
        backdrop-filter: blur(5px);
        background-color: rgba(0, 0, 0, 0.4);
      }

      /* ANIMASI MODAL (Zoom + Bounce) */
      @keyframes modalFadeZoomBounce {
        0% {
          opacity: 0;
          transform: scale(0.8);
        }
        55% {
          opacity: 1;
          transform: scale(1.05);
        }
        75% {
          transform: scale(0.97);
        }
        100% {
          transform: scale(1);
        }
      }

      .modal.show .modal-dialog {
        animation: modalFadeZoomBounce 0.4s ease-out;
      }

      /* ANIMASI STATIC BACKDROP (GETAR) */
      @keyframes staticBackdrop {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }
      .modal-static-anim {
        animation: staticBackdrop 0.3s ease-in-out;
      }

      /* ANIMASI SCROLLBAR */
      .modal-content::-webkit-scrollbar {
        width: 6px;
      }
      .modal-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      .modal-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
      }
      .modal-content::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="card card-custom">
        <div
          class="header-bg d-flex justify-content-between align-items-center">
          <h1 class="card-title h4 mb-0">Guidance Material Menu</h1>
          <a href="index.html" class="btn btn-sm btn-outline-light"
            ><i class="bi bi-house"></i> Home</a
          >
        </div>

        <div class="card-body">
          <div class="row mb-4 align-items-end">
            <div class="col-md-5 mb-2 mb-md-0">
              <label for="cardNameSelect" class="form-label small"
                >1. Choose Card Menu</label
              >
              <select id="cardNameSelect" class="form-select"></select>
            </div>
            <div class="col-md-5 mb-2 mb-md-0">
              <label for="categoryFilter" class="form-label small"
                >2. Filter by Category</label
              >
              <select id="categoryFilter" class="form-select"></select>
            </div>
            <div class="col-md-2">
              <button id="refreshBtn" class="btn btn-primary w-100">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
          </div>

          <div id="contentArea">
            <p class="text-muted text-center py-5">Loading guidance data...</p>
          </div>

          <div
            id="loadingStatus"
            class="small text-muted text-center mt-3"
            style="display: none"></div>
        </div>
      </div>
    </div>

    <div id="contentModal" class="content-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">Judul Panduan</h2>
          <button class="close-btn" id="closeModal">&times;</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // ⭐️ GANTI INI DENGAN URL DEPLOYMENT GAS ANDA
      const GAS_WEB_APP_URL = GLOBAL_CONFIG.GAS_WEB_APP_URL;

      window.handleMediaError = function (imgElement, fileId) {
        const container = imgElement.parentElement;
        const pdfUrl = `https://drive.google.com/file/d/${fileId}/preview`;

        container.innerHTML = `
        <div class="pdf-wrapper">
           <iframe src="${pdfUrl}" class="pdf-frame" allow="autoplay"></iframe>
        </div>
        <div class="pdf-action-bar">
           <a href="https://drive.google.com/file/d/${fileId}/view" target="_blank" class="btn btn-sm btn-outline-dark rounded-pill px-4">
             <i class="bi bi-arrows-fullscreen"></i> Fullscreen / Download
           </a>
        </div>
      `;
      };

      function getDriveId(url) {
        if (!url) return null;
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        return match ? match[1] : null;
      }

      let ALL_GUIDANCE_DATA = null;
      let ALL_CARD_NAMES = [];
      let CURRENT_USER_CATEGORIES = ["FLOORING", "BATHROOM", "ALL"];

      const cardNameSelect = document.getElementById("cardNameSelect");
      const categoryFilter = document.getElementById("categoryFilter");
      const contentArea = document.getElementById("contentArea");
      const refreshBtn = document.getElementById("refreshBtn");
      const loadingStatus = document.getElementById("loadingStatus");
      const contentModal = document.getElementById("contentModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalBody = document.getElementById("modalBody");
      const closeModal = document.getElementById("closeModal");

      // ----------------------------------------------------
      // A. FETCH DATA
      // ----------------------------------------------------
      async function fetchGuidanceData() {
        loadingStatus.textContent = "Fetching data...";
        loadingStatus.style.display = "block";
        cardNameSelect.disabled = true;
        categoryFilter.disabled = true;
        refreshBtn.disabled = true;

        try {
          const url = `${GAS_WEB_APP_URL}?page=guidance&action=get_data`;
          const response = await fetch(url);
          const result = await response.json();

          if (!response.ok || result.error)
            throw new Error(
              result.message || `HTTP error! Status: ${response.status}`
            );

          ALL_GUIDANCE_DATA = result.data;
          ALL_CARD_NAMES = result.cardList || [];

          populateSelectors(ALL_CARD_NAMES);
          renderContent();
        } catch (error) {
          contentArea.innerHTML = `<div class="alert alert-danger">Failed to load data: ${error.message}</div>`;
        } finally {
          loadingStatus.style.display = "none";
          cardNameSelect.disabled = false;
          refreshBtn.disabled = false;
          if (cardNameSelect.value) categoryFilter.disabled = false;
        }
      }

      // ----------------------------------------------------
      // B. POPULATE SELECTORS
      // ----------------------------------------------------
      function populateSelectors(cardNames) {
        cardNameSelect.innerHTML =
          '<option value="">-- Select Card Menu --</option>';

        const availableCardNames = cardNames.filter((name) => {
          const data = ALL_GUIDANCE_DATA[name];
          if (!data) return false;
          return data.categories.some((cardCat) =>
            CURRENT_USER_CATEGORIES.includes(cardCat)
          );
        });

        availableCardNames.forEach((name) => {
          cardNameSelect.innerHTML += `<option value="${name}">${name}</option>`;
        });

        if (availableCardNames.length > 0) {
          cardNameSelect.value = availableCardNames[0];
        } else {
          cardNameSelect.value = "";
        }

        cardNameSelect.dispatchEvent(new Event("change"));
      }

      function updateCategoryFilter() {
        const selectedCardName = cardNameSelect.value;
        categoryFilter.innerHTML =
          '<option value="">-- Show All Available --</option>';

        if (!selectedCardName || !ALL_GUIDANCE_DATA[selectedCardName]) {
          categoryFilter.disabled = true;
          return;
        }

        const categories = ALL_GUIDANCE_DATA[selectedCardName].categories;

        const userAvailableCategories = categories.filter((cat) =>
          CURRENT_USER_CATEGORIES.includes(cat)
        );

        userAvailableCategories.sort().forEach((cat) => {
          if (cat !== "ALL") {
            categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
          }
        });
        categoryFilter.disabled = false;
      }

      // ----------------------------------------------------
      // C. RENDER CONTENT - GRID DENGAN CARD JUDUL SAJA
      // ----------------------------------------------------
      function renderContent() {
        const selectedCardName = cardNameSelect.value;
        const selectedCategory = categoryFilter.value;
        contentArea.innerHTML = "";

        if (!selectedCardName) {
          contentArea.innerHTML =
            '<p class="text-muted text-center py-5">Please select a Card Menu to view content.</p>';
          return;
        }

        const cardData = ALL_GUIDANCE_DATA[selectedCardName];
        let gridHtml = '<div class="guidance-grid">';
        let hasVisibleContent = false;

        // Loop per CONNECTION (judul)
        for (const connection in cardData.connections) {
          const conn = cardData.connections[connection];

          // Filter berdasarkan kategori
          const isVisibleByCardCategory =
            !selectedCategory ||
            cardData.categories.includes(selectedCategory) ||
            cardData.categories.includes("ALL");

          if (isVisibleByCardCategory) {
            hasVisibleContent = true;

            // ⭐️ PERBAIKAN: Menggunakan properti totalItems yang sudah dihitung unik di server
            // Fallback ke Object.keys(conn.items).length jika totalItems belum tersedia
            const subItemCount =
              conn.totalItems || Object.keys(conn.items).length;

            gridHtml += `
                <div class="title-card" data-connection="${connection}">
                    <div class="title-card-header">
                        ${conn.title || connection}
                    </div>
                    <div class="title-card-body">
                        ${subItemCount} item${
              subItemCount !== 1 ? "s" : ""
            } available
                    </div>
                </div>
            `;
          }
        }

        gridHtml += "</div>";

        if (hasVisibleContent) {
          contentArea.innerHTML = gridHtml;

          // Tambahkan event listener untuk setiap card
          document.querySelectorAll(".title-card").forEach((card) => {
            card.addEventListener("click", function () {
              const connection = this.getAttribute("data-connection");
              // Perlu ada fungsi showConnectionContent() yang menangani tampilan detail di grid
              // Jika Anda menggunakan Grid Accordion (seperti di jawaban saya sebelumnya), logic ini akan berbeda
              // Untuk saat ini, kita biarkan pemanggilan fungsi lama
              if (typeof showConnectionContent === "function") {
                showConnectionContent(selectedCardName, connection);
              } else {
                console.error("Fungsi showConnectionContent tidak ditemukan.");
              }
            });
          });
        } else {
          contentArea.innerHTML =
            '<div class="no-data-message">No material found for the selected filter.</div>';
        }
      }

      // ----------------------------------------------------
      // D. FUNGSI UNTUK MENAMPILKAN KONTEN DI MODAL
      // ----------------------------------------------------
      function showConnectionContent(cardName, connection) {
        const cardData = ALL_GUIDANCE_DATA[cardName];
        const conn = cardData.connections[connection];

        // Set judul modal
        modalTitle.textContent = conn.title || connection;

        // Buat konten untuk modal - TAMPILKAN LIST SUB-TITLE DULU
        let contentHtml = `
          <div id="subtitleList" class="subtitle-list">
        `;

        // Loop per SUB_TITLE untuk membuat list
        for (const subTitle in conn.items) {
          const guidances = conn.items[subTitle];
          const itemCount = guidances.length;

          contentHtml += `
            <div class="subtitle-item" data-subtitle="${subTitle}">
              <p class="subtitle-text">${subTitle}</p>
              <span class="subtitle-arrow">→</span>
            </div>
          `;
        }

        contentHtml += `</div>`;

        modalBody.innerHTML = contentHtml;
        contentModal.style.display = "block";

        // Tambahkan event listener untuk setiap sub-title
        document.querySelectorAll(".subtitle-item").forEach((item) => {
          item.addEventListener("click", function () {
            const subTitle = this.getAttribute("data-subtitle");
            showSubtitleDetail(cardName, connection, subTitle);
          });
        });
      }

      // ----------------------------------------------------
      // E. FUNGSI UNTUK MENAMPILKAN DETAIL SUB-TITLE
      // ----------------------------------------------------
      window.showSubtitleDetail = function (cardName, connection, subTitle) {
        const cardData = ALL_GUIDANCE_DATA[cardName];
        const conn = cardData.connections[connection];
        const guidances = conn.items[subTitle];

        let detailHtml = `
          <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
            <button class="back-btn me-3" onclick="showConnectionContent('${cardName}', '${connection}')" title="Back">
                <i class="bi bi-arrow-left-circle-fill" style="font-size: 1.5rem;"></i>
            </button>
            <h4 class="m-0 fw-bold" style="color:var(--primary-color)">${subTitle}</h4>
          </div>
        `;

        guidances.forEach((g) => {
          // Text
          if (g.text)
            detailHtml += `<div class="guidance-text mb-4">${g.text}</div>`;

          // Media
          if (g.img) {
            const url = g.img.trim();
            const fileId = getDriveId(url);
            const fileType = (g.type || "img").toLowerCase();

            if (fileType === "pdf") {
              // PDF Handling
              let pdfSrc = url;
              if (fileId) {
                pdfSrc = `https://drive.google.com/file/d/${fileId}/preview`;
              }

              detailHtml += `
                  <div class="pdf-wrapper">
                     <iframe src="${pdfSrc}" class="pdf-frame" allow="autoplay"></iframe>
                  </div>
                  <div class="pdf-action-bar">
                     <a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill px-4">
                       <i class="bi bi-box-arrow-up-right"></i> Open PDF in New Tab
                     </a>
                  </div>`;
            } else {
              // Image Handling
              let imgSrc = url;
              if (fileId) {
                // High-Res Thumbnail
                imgSrc = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1600`;
              }

              detailHtml += `
                 <div class="text-center mb-4">
                   <img 
                     src="${imgSrc}" 
                     class="img-fluid rounded shadow-sm" 
                     style="max-height: 80vh; width: auto; max-width: 100%; object-fit: contain;"
                     alt="Guidance Image" 
                     loading="lazy"
                   />
                 </div>
               `;
            }
          }
        });

        modalBody.innerHTML = detailHtml;
        // Scroll modal to top
        modalBody.scrollTop = 0;
      };

      // ----------------------------------------------------
      // F. EVENT LISTENERS & INIT
      // ----------------------------------------------------
      document.addEventListener("DOMContentLoaded", () => {
        cardNameSelect.addEventListener("change", () => {
          updateCategoryFilter();
          renderContent();
        });

        categoryFilter.addEventListener("change", renderContent);
        refreshBtn.addEventListener("click", fetchGuidanceData);

        // Event listener untuk menutup modal
        closeModal.addEventListener("click", function () {
          contentModal.style.display = "none";
        });

        // ⭐️ LOGIKA BARU: STATIC BACKDROP EFFECT (Getar saat klik luar)
        contentModal.addEventListener("click", function (e) {
          if (e.target === contentModal) {
            // Ambil elemen konten di dalam modal
            const modalBox = contentModal.querySelector(".modal-content");

            // Tambahkan class animasi
            modalBox.classList.add("modal-static-anim");

            // Hapus class setelah animasi selesai (300ms sesuai CSS)
            setTimeout(() => {
              modalBox.classList.remove("modal-static-anim");
            }, 300);
          }
        });

        // Tutup modal dengan tombol ESC
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && contentModal.style.display === "block") {
            contentModal.style.display = "none";
          }
        });

        fetchGuidanceData();
      });
    </script>
  </body>
</html>
